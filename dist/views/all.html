<script type="text/html" id="breadcrumb-template">
  <ul class="breadcrumb">
    <li>
      <span data-bind="if: !mapperName">
        <span class="active">Home</span>
      </span>
      <span data-bind="if: mapperName">
        <a data-bind="click: deselect" href="#">Home</a>
      </span>
    </li>
    <li data-bind="if: mapperName">
      <span class="divider">/</span>
      <span data-bind="text: mapperName" class="active"></span>
    </li>
  </ul>
</script>
<script type="text/html" id="geospecify-template">
  <div id="map" class="google-maps"></div>
  <style>
    #map {
      height: 300px;
      width: 600px;
    }
  </style>
  <form id="addressForm" data-bind="submit: submit">
    <!-- TODO: Autocomplete for address as they type it in?-->
    <input id="address" placeholder="1 Embarcadero Center, San Francisco, CA 94111" />
    <button type="submit" class="btn">Update address</button>
  </form>
  <p id="geoOutput">Resolving location...</p>
  <script>
    var JOYENT = {
      'lat': 37.7943446,
      'lng': -122.399981
    },
    NODEJITSU = {
      'lat': 40.7142,
      'lng': -74.0064
    },
    DEFAULT = NODEJITSU;

    $(function () {
      // Grab the output
      var $geoOutput = $('#geoOutput');

      // Generate our map
      var map = new GMaps({
        'div': '#map',
          'lat': DEFAULT.lat,
          'lng': DEFAULT.lng
      });

      // Add a draggable location marker
      var marker = map.addMarker({
        'lat': DEFAULT.lat,
          'lng': DEFAULT.lng,
          'draggable': true,

        // When it is done being dragged, output location updated
        'dragend': onDragend

        // Open a context menu

      });

      function updateCoordsFn(coords) {
        var coords = {
          'lat': coords.lat(),
            'lng': coords.lng()
        };
        updateCoords(coords);
      }

      // Helper method to update coordinates
      function updateCoords(coords) {
        var latLng = new google.maps.LatLng(coords.lat, coords.lng);
        map.setCenter(coords.lat, coords.lng);
        marker.setPosition(latLng);

        // Output the location
        outputLocation();
      }

      // When the location is updated via the map, output it
      function onDragend() {
        outputLocation();
      }

      // Output the current location
      function outputLocation() {
        var position = marker.getPosition();
        $geoOutput.text('Latitude: ' + position.lat() + ', Longitude: ' + position.lng());
      }

      // Get the coordinates
      getCoordinates(function (err, coords) {
        // If there are coordinates, update the map to them
        if (coords) {
          // Set coordinates of map
          updateCoords({
            'lat': coords.latitude,
              'lng': coords.longitude
          });
        }
      });

      // When the form is submitted
      var $address = $('#address'),
        $addressForm = $('#addressForm');
      $addressForm.on('submit', function (e) {
        // Do not submit
        e.preventDefault();

        // Look up the address
        var address = $address.val();
        GMaps.geocode({
          'address': address,
            'callback': function (results, status) {
            if (status === 'OK') {
              // If there are results
              if (results.length > 0) {
                // Pick the first one
                var firstResult = results[0],
                  location = firstResult.geometry.location;

                // and update the map with it
                updateCoordsFn(location);
              }
            }
          }
        });
      });

      // When the map is right clicked, open a context menu
      map.setContextMenu({
        control: 'map',
        options: [{
          // with the option of "Move marker to here"
          title: 'Move marker to here',
          name: 'move_marker',

          // If the "Move marker to here" is clicked
          action: function (e) {
            // Move the marker to the point of interaction
            var location = e.latLng;
            updateCoordsFn(location);
          }
        }]
      });
    });
  </script>
</script>
<script type="text/html" id="index">
  <div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
      <div class="container">
        <a href="#" class="brand">Mapper Maker</a>
        <div class="nav-collapse collapse navbar-responsive-collapse">
          <div data-bind="if: !user()">
            <a class="btn btn-primary pull-right"
              href="https://www.dailycred.com/oauth/gateway?client_id=a17d7abb-849a-4fd1-ad9c-eff1eaf0cfb0&amp;response_type=token">Login to Contribute</a>
          </div>
          <div data-bind="if: user">
            <button
              class="btn btn-success pull-right"
              data-target="#contributionModal"
              data-toggle="modal">Add Contribution</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div data-bind="if: selectedMapper" class="container paddingPush">
    <div data-bind="template: {
        name: 'breadcrumb-template',
        data: selectedMapper
      }"></div>
    <section class="container">
      <div data-bind="template: {
        name: 'mapper-template',
        data: selectedMapper
      }" class="mapper"></div>
    </section>
  </div>
  <section data-bind="if: !selectedMapper()" class="container">
    <div data-bind="template: {
      name: 'breadcrumb-template',
      data: {'mapperName': null}
    }"></div>
    <form class="form-search pull-right">
      <input
        type="text"
        placeholder="Search mappers..."
        class="input-medium search-query">
    </form>
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th>Mapper</th>
          <th>Contributions</th>
          <th>Last Updated</th>
        </tr>
      </thead>
      <tbody data-bind="foreach: mappers">
        <tr data-bind="click: select" class="actionable">
          <td data-bind="text: mapperName"></td>
          <td data-bind="text: numContributions"></td>
          <td data-bind="text: lastUpdated"></td>
        </tr>
      </tbody>
    </table>
  </section>
  <div id="contributionModal" class="modal hide fade">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      <h3>Add Mapper Maker contribution</h3>
    </div>
    <div class="modal-body">
      <form class="form-horizontal">
        <div>
          Geo select
        </div>
        <div class="control-group">
          <label class="control-label" for="lat">Latitude</label>
          <div class="controls">
            <span>37.7943446</span>
          </div>
        </div>
        <div class="control-group">
          <label class="control-label" for="lng">Latitude</label>
          <div class="controls">
            <span>-122.399981</span>
          </div>
        </div>
        <div class="control-group">
          <label class="control-label" for="keywords">Keywords (Comma separated)</label>
          <div class="controls">
            <input type="text" id="keywords" placeholder="">
          </div>
        </div>
        <div class="control-group">
          <label class="control-label" for="url">URL (Optional)</label>
          <div class="controls">
            <input type="text" id="url" placeholder="URL">
          </div>
        </div>
        <div class="control-group">
          <label class="control-label" for="desc">Description (Optional)</label>
          <div class="controls">
            <input type="text" id="desc" placeholder="My cat, jazzycat. meow.">
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
      <button class="btn btn-primary">Submit Contribtion</button>
    </div>
  </div>
</script>
<script type="text/html" id="mapper-template">
  <h2 data-bind="text: mapperName"></h2>
  <p>Updated: <span data-bind="text: lastUpdated"></span></p>
</script>